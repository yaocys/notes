# CAS

## 概述

### 是什么？

* 全称Compare And Swap，比较并交换

* 是一种乐观锁的实现，采用非阻塞算法来代替锁定

  > JUC包下的AutomicInteger就是借助CAS实现的
  >
  > 为什么有原子类？
  >
  > 例如`i++`操作是非原子的，所以用原子类来保证原子操作

* 底层由硬件实现，保证原子性，涉及三个值

  1. 当前内存值V
  
     > 操作结束，但还没写入新值，对应内存中的值

  2. 预期值（旧内存值）O
  
     > 操作开始前，对应内存中的值
  
  3. 即将更新的值U
  
  当且仅当预期值O与当前内存值V相等时，将内存值V修改为更新值U，返回true，否则返回false（撤销操作）
  
  > 一般情况下是一个自旋操作，即不断地重试
  
  所以意义就是，只有在自己操作的过程中，操作对象内有被修改才会写入

### 实现了什么？

### 有什么缺点？

#### ABA问题



 但 CAS 也不是没有任何副作用，比如著名的 ABA 问题就是 CAS 引起的。

> 在JDK1.5 中新增 java.util.concurrent (J.U.C)就是建立在CAS之上的
>
> 相对于对于 synchronized 这种阻塞算法，CAS是非阻塞算法的一种常见实现。所以J.U.C在性能上有了很大的提升

CAS算法涉及三个操作数

1. 需要读写的内存值V
2. 进行比较的值A
3. 拟写入的新值B

更新一个变量的时候，只有当变量的预期值A和内存地址V中的实际值相同时，才会将内存地址V对应的值修改为B，否则不会进行任何操作



## JMM

## 概述

Java内存模型，定义了主存、工作内存抽象概念，底层对应CPU寄存器、缓存、硬件内存、CPU指令优化等

体现在以下几个方面

* 原子性：保证指令不会受到线程上下文切换的影响

* 可见性：保证指令不会受到CPU缓存的影响

* 有序性：保证指令不会受到CPU指令并行优化的影响

  > 指令重排：JVM可以在不影响正确性的前提下，调整语句的执行顺序
  >
  > 现代CPU执行多级流水线
