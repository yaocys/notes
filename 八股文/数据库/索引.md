## 数据库

---

### SQL

1. 介绍一下数据库分页

   MySQL中可以使用`LIMIT`子句实现分页查询

   ```sql
   SELECT prod_name FROM products LIMIT 5;-- 返回前五行记录
   SELECT prod_name FROM products LIMIT 5,5;-- 从第五行开始，返回5行
   ```

   优化`LIMIT`分页

   在偏移量非常大的时候，例如`LIMIT 10000,20`，这时MySQL需要查询10020条记录后只返回最后20条，前面的10000条记录都将被抛弃，这样的代价是非常高的。

   >  如果所有的页面被访问的频率都相同，那么这样的查询平均需要访问半个表的数据

   要优化这种查询，要么在页面中限制分页的数量，要么优化大量偏移的性能

   最简单的办法就是：**尽可能地使用索引覆盖扫描**，而不是查询所有的列，然后根据需要做一次关联操作再返回所需的列。

   ```sql
   SELECT film_id,description FROM sakila.film ORDER BY title LIMIT 50,5;
   -- 如果这个表非常大，这个查询最好改成下面的样子
   SELECT film.film_id,film.description  FROM sakila.film INNER JOIN (  SELECT film_id FROM sakila.film ORDER BY title LIMIT 50,5 ) AS lim USING(film_id);
   -- 这里的“延迟关联”将大大提升查询效率，它让MySQL扫描尽可能少的页面，获取需要访问的记录后再根据关联列回原表查询需要的所有列
   -- 这个技术也可以优化关联查询中的LIMIT子句
   ```

   有时候也可以**将`LIMIT`查询转换为已知位置的查询**，让MySQL通过范围扫描获得对应的结果

   例如：如果在一个位置列上有索引，并且预先计算出了边界值，上面的查询就可以写为

   ```sql
   SELECT film_id,description FROM skila.film WHERE position BETWEEN 50 AND 54 ORDER BY position;
   ```

   > 对数据进行排名的问题也与此类似，但往往还会同时和GROUP BY混合使用，在这种情况下通常都需要预先计算并存储排名信息

   LIMIT和OFFSET的问题，其实是OFFSET的问题，它会导致MySQL扫描大量不需要的行然后再抛弃掉。如果可以使用书签记录上次取数的位置，那么下次就可以直接从该书签记录的位置开始扫描，这样就可以避免使用OFFSET。

   例如，若需要按照租赁记录做翻页，那么可以根据最新一条租赁记录向后追溯，这种做法可行是因为租赁记录的主键是单调增长的。首先使用下面的查询获得第一组结果：

   ```sql
   SELECT * FROM sakila.rental ORDER BY rental_id DESC LIMIT 20;
   ```

   假设上面的查询返回的是主键16049到16030的租赁记录，那么下一页查询就可以从16030这个点开始：

   ```sql
   SELECT * FROM sakila.rental  WHERE rental_id < 16030 ORDER BY rental_id DESC LIMIT 20;
   ```

   该技术的好处是无论翻页到多么后面，其性能都会很好。

4. SQL中怎么将行转成列的？

### 索引

1. ***说一说你对MySQL索引的理解***

   索引是一个单独的、存储在磁盘上的数据结构，包含着对数据表里所有记录的引用指针。使用索引可以快速找出在某个或多个列中有一特定值的行，所有MySQL列类型都可以被索引，对相关列使用索引是提高查询操作速度的最佳途径

   > 索引是在存储引擎中实现的，因此，每种存储引擎的索引都不一定完全相同，并且每种存储引擎也不一定支持所有索引类型
   >
   > MySQL中索引的存储类型有两种，即B-Tree和Hash，具体和表的存储引擎相关
   >
   > MyISAM和InnoDB存储引擎只支持BTREE索引
   >
   > MEMORY/HEAP存储引擎可以支持HASH和BTREE索引

   索引的优点主要有：

   1. 通过创建唯一索引，可以保证数据库表中每一行数据的唯一性
   2. 可以大大加快数据的查询速度，这也是创建索引的主要原因
   3. 在实现数据的参考完整性方面，可以加速表和表之间的连接
   4. 在使用分组和排序子句进行数据查询时，也可以显著减少查询中分组和排序的时间

   缺点：

   1. 创建和维护索引需要耗费时间，并且随着数据量的增加所耗费的时间也会增加
   2. 索引需要占据磁盘空间，除了数据表占数据空间之外，每一个索引还要占一定的物理空间，如果有大量的索引，索引文件可能比数据文件更快达到最大文件尺寸
   3. 当对表中的数据进行增加、删除和修改的时候，索引也要动态地维护，这降低了数据地维护速度

2. ***索引有哪几种？***

   1. 普通索引

      是MySQL中基本索引类型，允许在定义索引的列中插入重复值和空值

   2. 唯一索引

      要求索引的列值必须唯一，但允许有空值。如果是组合索引，则列值的组合必须唯一

      主键索引是一种特殊的唯一索引，不允许有空值

   3. 单列索引

      即一个索引只包含单个列，一个表可以有多个单列索引

   4. 组合索引

      指在表的多个字段组合上创建的索引，只有在查询条件中使用了这些字段的左边字段时，索引才会被使用

      使用组合索引时遵循==最左前缀集合==

      > **最左前缀匹配原则**
      >
      > 

   5. 全文索引

      类型为`FULLTEXT`，在定义索引的列上支持值的全文查找，允许在这些索引列中插入重复值和空值。

      > 全文索引可以在`CHAR`、`VARCHAR`、`TEXT`类型的列上创建

   6. 空间索引

      是对空间数据类型的字段建立的索引

      > MySQL中的空间数据类型有4种，分别是GEOMETRY、POINT、LINESTRING和POLYGON。

      MySQL使用SPATIAL关键字进行扩展，使得能够用创建正规索引类似的语法创建空间索引。

      创建空间索引的列，必须将其声明为NOT NULL，空间索引只能在存储引擎为MyISAM的表中创建。

3. ***如何创建及保存MySQL的索引？***

   * 在创建表的时候创建索引

     ```sql
     CREATE TABLE table_name [col_name data_type] [UNIQUE|FULLTEXT|SPATIAL] [INDEX|KEY] [index_name] (col_name [length]) [ASC|DESC]
     ```

     > `INDEX`和`KEY`为同义词，两者作用相同，用来指定创建索引

   * 在已存在的表上创建索引

     ```sql
     ALTER TABLE table_name ADD  [UNIQUE|FULLTEXT|SPATIAL] [INDEX|KEY] [index_name] (col_name[length],...) [ASC|DESC]
     ```

     ```sql
     CREATE [UNIQUE|FULLTEXT|SPATIAL] INDEX index_name  ON table_name (col_name [length],...) [ASC|DESC]
     ```

4. ***MySQL怎么判断要不要加索引？***

   建议按照以下原则：

   1. 当唯一性是某种数据本身的特征时，指定唯一索引。使用唯一索引能确保定义的列的数据完整性，以提高查询速度
   2. 在频繁进行排序或分组的列上建立索引，如果待排序的列有多个，可以在这些列上建立组合索引

5. ***只要创建了索引，就一定会走索引吗？***

   不一定

   例如：在使用组合索引的时候，如果没有遵从最左前缀的原则进行搜索，则索引是不起作用的

6. ***如何判断数据库的索引有没有生效？***

   可以使用`EXPLAIN`语句查看索引是否正在使用

   > 例如：
   >
   > ```sql
   > EXPLAIN SELECT * FROM book WHERE year_publication=1990;
   > ```
   >
   > `EXPLAIN`语句将为我们输出详细的SQL执行信息，其中：
   >
   > * possible_keys行给出了MySQL在搜索数据记录时可选用的各个索引。
   > * key行是MySQL实际选用的索引。
   >
   > 如果possible_keys行和key行都包含year_publication字段，则说明在查询时使用了该索引。

#### 建立索引的原则

   1. 避免对**经常更新**的表进行过多的索引，并且索引中的列要尽可能少。

      应该经常用于查询的字段创建索引，但要避免添加不必要的字段

   2. **数据量小**的表最好不要使用索引

      由于数据较少，查询花费的时间可能比遍历索引的时间还要短，索引可能不会产生优化效果

   3. 在**条件表达式中经常用到的不同值较多的**列上建立索引，在数据重复且分布均匀的列上不要建立索引

      例如：”性别“字段

   4. 当唯一性是某种数据本身的特征时，指定唯一索引。使用唯一索引需能确保定义的列的数据完整性，以提高查询速度。

   5. 在**频繁进行排序或分组**的列上建立索引，如果待排序的列有多个，可以在这些列上建立组合索引



   1. ***索引是越多越好吗？***

